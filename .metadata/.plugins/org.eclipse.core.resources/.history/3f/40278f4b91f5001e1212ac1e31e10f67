package com.jspstudy.ch06_1.controller;

import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.jspstudy.ch06_1.vo.Board;

@WebServlet("/boardList")
public class BoardListController extends HttpServlet {

	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
		String user = "scott";
		String pass = "tiger";
		String driver = "oracle.jdbc.driver.OracleDriver";
		String url = "jdbc:oracle:thin@localhost:1521:xe";
		
		// 데이터베이스 작업에 필요한 객체 타입으로 변수를 선언
		// Connection 객체는 DB에 연결해 작업을 수행할 수 있도록 지원하는 객체
		Connection conn = null;
		
		// Statement, PreparedStatement 객체는 DB에 쿼리를 발행하는 객체
		PreparedStatement pstmt = null;
		
		// ResultSet 객체는 DB에 select 쿼리를 발행한 결과를 저장하는 객체
		ResultSet rs = null;
		
		// 여러개의 게시글을 ArrayList에 저장하기 위한 객체
		ArrayList<Board> boardList = null;
		
		try {
			// 접속하려는 DBMS의 드라이버를 로딩한다.
			// * Oracle드라이버를 WEB-INF/lib 폴더에 추가해야한다.
			Class.forName(driver);
			
			// 2. 데이터 베이스 연결 - DB커넥션을 생성한다.
			conn = DriverManager.getConnection(url, user, pass);
			// 3. DBMS에 SQL쿼리를 발생하기 위해 활성화된 Connection 객체로 부터 PreparedStatement 객체를 얻는다.
			pstmt = conn.prepareStatement("SELECT * FROM jspbbs ODER BY no DESC");
			// 4. 쿼리를 실행하여 SELECT한 결과를 ResultSet 객체로 받는다.
			rs = pstmt.executeQuery();
			// 게시글 리스트를 저장할 ArrayList 객체 생성
			boardList = new ArrayList<Board>();
			// 5. 쿼리 실행결과를 바탕으로 while문을 이용해 데이터를 출력한다.
			while(rs.next()) {
				Board b = new Board();
				b.setNo(rs.getInt(1));
				b.setTitle(rs.getString("title"));
				b.setWriter(rs.getString("writer"));
				b.setRegDate(rs.getTimestamp("reg_date"));
				b.setReadCount(rs.getInt("resd_count"));
				b.setFile1(rs.getString("file1"));
				
				boardList.add(b);
			}
		
		} catch (SQLException e) {
			e.printStackTrace();	
		} catch (ClassNotFoundException e) {
			e.printStackTrace();
		}// catch end
		finally {
			try {
				if(rs != null)rs.close();
				if(pstmt != null)pstmt.close();
				if(conn != null)conn.close();
			} catch (SQLException e) {
				e.printStackTrace();
			} // catch end			
		} // finally end
		
		request.setAttribute("bList", boardList);
		
		RequestDispatcher rd = request.getRequestDispatcher("/WEB-INF/board/boardList01.jsp");
		rd.forward(request, response);
		
	} // method end
	
} // class end
